<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Artworks</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div class="wrap">
    <div class="card">

      <div class="headerbar">
        <h2 style="margin:0;">List Of Artworks</h2>
        <div class="header-actions">
          <a class="btn" href="{{ url_for('add_artwork') }}">Add artwork</a>
          <button class="btn" id="printBtn" type="button">Print page</button>
        </div>
      </div>

      {% set mediums = artworks | map(attribute='medium') | select | list %}
      {% set years = artworks | map(attribute='year') | select | list %}
      {% set projects = artworks | map(attribute='series') | select | list %}

      <div class="controls">
        <div class="filters">
          <input id="q" type="search" placeholder="Search title, medium, project, year, ID…">

          <select id="fMedium">
            <option value="">All materials</option>
            {% for m in mediums|unique|sort %}
              <option value="{{ m|e }}">{{ m }}</option>
            {% endfor %}
          </select>

          <select id="fYear">
            <option value="">All dates</option>
            {% for y in years|unique|sort %}
              <option value="{{ y|e }}">{{ y }}</option>
            {% endfor %}
          </select>

          <select id="fProject">
            <option value="">All projects</option>
            {% for p in projects|unique|sort %}
              <option value="{{ p|e }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="chips" style="gap:8px; flex-wrap:wrap;">
          <span class="chip">Total: <strong id="total">{{ artworks|length }}</strong></span>
          <span class="chip">Shown: <strong id="shown">{{ artworks|length }}</strong></span>

          <!-- server-side status filter buttons -->
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <a class="btn-small {% if not status %}active{% endif %}" href="{{ url_for('artwork_list') }}">All</a>
            <a class="btn-small {% if status=='for_sale' %}active{% endif %}" href="{{ url_for('artwork_list', status='for_sale') }}">For sale</a>
            <a class="btn-small {% if status=='sold' %}active{% endif %}" href="{{ url_for('artwork_list', status='sold') }}">Sold</a>
          </div>

          <button class="btn-small" id="resetBtn" type="button">Reset</button>
          <span class="muted" id="activeText"></span>
        </div>
      </div>

      {% if artworks and artworks|length > 0 %}
        <div class="items" id="items">
          {% for artwork in artworks %}
            <div class="row"
              data-medium="{{ (artwork.medium or '')|lower|e }}"
              data-year="{{ (artwork.year or '')|lower|e }}"
              data-project="{{ (artwork.series or '')|lower|e }}"
              data-search="{{ (
                (artwork.title or '') ~ ' ' ~
                (artwork.medium or '') ~ ' ' ~
                (artwork.series or '') ~ ' ' ~
                (artwork.year or '') ~ ' ' ~
                (artwork.id|string)
              )|lower|e }}"
            >
              <a class="rowlink"
                 href="{{ url_for('artwork_detail', artwork_id=artwork.id) }}"
                 style="text-decoration:none; color:inherit; flex:1; min-width:0;"
              >
                <div class="item">
                  <div class="thumb">
                    {% if artwork.image_filename %}
                      <img src="{{ url_for('uploaded_file', filename=artwork.image_filename) }}" alt="">
                    {% endif %}
                  </div>

                  <div class="textlist">
                    <div class="title">{{ artwork.title }}</div>
                    <div class="meta">
                      {{ artwork.year or "—" }} · {{ artwork.medium or "—" }}
                      {% if artwork.series %} · {{ artwork.series }}{% endif %}
                      · ID {{ artwork.id }}
                    </div>
                  </div>

                  <div class="right">
                           <!-- actions (not inside the <a>, so it won’t break clicks) -->
              <div style="display:flex; align-items:center; gap:8px;">
                <form method="post"
                      action="{{ url_for('delete_artwork', artwork_id=artwork.id) }}"
                      onsubmit="return confirm('Delete this artwork? This cannot be undone.');"
                      style="margin:0;"
                >
                  <button type="submit" class="btn-delete" style="opacity:.85;">Delete</button>
                </form>
              </div>
                    {% if artwork.for_sale %}
                      <span class="tag">For sale</span>
                    {% else %}
                      <span class="tag" style="opacity:.65;">Sold</span>
                    {% endif %}
                  </div>
             
                </div>
              </a>
            </div>
          {% endfor %}
        </div>

        <p id="emptyState" class="muted" style="display:none; margin-top:14px;">
          No artworks match your filters.
        </p>
      {% else %}
        <p class="muted" style="margin-top:14px;">No artworks yet.</p>
      {% endif %}

      <a class="back" href="{{ url_for('home') }}">← Home</a>
    </div>
  </div>

  <script>
    (function(){
      const q = document.getElementById('q');
      const fMedium = document.getElementById('fMedium');
      const fYear = document.getElementById('fYear');
      const fProject = document.getElementById('fProject');

      const items = document.getElementById('items');
      const emptyState = document.getElementById('emptyState');

      const shown = document.getElementById('shown');
      const activeText = document.getElementById('activeText');
      const resetBtn = document.getElementById('resetBtn');
      const printBtn = document.getElementById('printBtn');

      const norm = (v) => (v || '').toString().trim().toLowerCase();

      function apply(){
        if (!items) return;

        const qs = norm(q.value);
        const m = norm(fMedium.value);
        const y = norm(fYear.value);
        const p = norm(fProject.value);

        const active = [];
        if (qs) active.push(`Search: “${q.value.trim()}”`);
        if (m) active.push(`Material: ${fMedium.value}`);
        if (y) active.push(`Date: ${fYear.value}`);
        if (p) active.push(`Project: ${fProject.value}`);
        activeText.textContent = active.length ? active.join(' · ') : '';

        let count = 0;
        const rows = items.querySelectorAll('.row');

        rows.forEach(row => {
          const ds = row.dataset;
          const okSearch = !qs || (ds.search || '').includes(qs);
          const okM = !m || (ds.medium || '') === m;
          const okY = !y || (ds.year || '') === y;
          const okP = !p || (ds.project || '') === p;

          const ok = okSearch && okM && okY && okP;
          row.style.display = ok ? '' : 'none';
          if (ok) count += 1;
        });

        shown.textContent = String(count);
        if (emptyState) emptyState.style.display = count === 0 ? '' : 'none';
      }

      function reset(){
        q.value = '';
        fMedium.value = '';
        fYear.value = '';
        fProject.value = '';
        apply();
      }

      [q, fMedium, fYear, fProject].forEach(el => {
        if (!el) return;
        el.addEventListener('input', apply);
        el.addEventListener('change', apply);
      });

      if (resetBtn) resetBtn.addEventListener('click', reset);
      if (printBtn) printBtn.addEventListener('click', function(){ window.print(); });

      apply();
    })();
  </script>
</body>
</html>
