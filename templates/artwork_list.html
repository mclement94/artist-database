<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Artworks</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div class="wrap">
    <div class="card">

      <div class="headerbar">
        <h2 style="margin:0;">List Of Artworks</h2>
        <div class="header-actions">
          <a class="btn" href="{{ url_for('artworks.add_artwork') }}">Add artwork</a>
          <button class="btn" id="printBtn" type="button">Print page</button>
        </div>
      </div>

      {% set mediums = artworks | map(attribute='medium') | select | list %}
      {% set years = artworks | map(attribute='year') | select | list %}
      {% set projects = artworks | map(attribute='series') | select | list %}

      <div class="controls">
        <div class="filters">
          <input id="q" type="search" placeholder="Search title, medium, project, year, ID‚Ä¶">

          <select id="fMedium">
            <option value="">All materials</option>
            {% for m in mediums|unique|sort %}
              <option value="{{ m|e }}">{{ m }}</option>
            {% endfor %}
          </select>

          <select id="fYear">
            <option value="">All dates</option>
            {% for y in years|unique|sort %}
              <option value="{{ y|e }}">{{ y }}</option>
            {% endfor %}
          </select>

          <select id="fProject">
            <option value="">All projects</option>
            {% for p in projects|unique|sort %}
              <option value="{{ p|e }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="chips" style="gap:8px; flex-wrap:wrap;">
          <span class="chip">Total: <strong id="total">{{ artworks|length }}</strong></span>
          <span class="chip">Shown: <strong id="shown">{{ artworks|length }}</strong></span>

          <!-- server-side status filter buttons -->
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <a class="btn-small {% if not status %}active{% endif %}" href="{{ url_for('artworks.artwork_list') }}">All</a>
            <a class="btn-small {% if status=='working' %}active{% endif %}" href="{{ url_for('artworks.artwork_list', status='working') }}">üîµ Working</a>
            <a class="btn-small {% if status=='for_sale' %}active{% endif %}" href="{{ url_for('artworks.artwork_list', status='for_sale') }}">üü¢ For sale</a>
            <a class="btn-small {% if status=='sold' %}active{% endif %}" href="{{ url_for('artworks.artwork_list', status='sold') }}">üî¥ Sold</a>
          </div>

          <button class="btn-small" id="resetBtn" type="button">Reset</button>
          <span class="muted" id="activeText"></span>
        </div>

        <!-- Bulk edit section (hidden by default) -->
        <div id="bulkEditSection" style="display:none; margin-top:16px; padding:12px; background:#f5f5f5; border-radius:4px; border:1px solid #ddd;">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <span style="font-weight:500;"><span id="selectedCount">0</span> selected</span>
            <select id="bulkField" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
              <option value="">Choose a field to update...</option>
              <option value="status">Status</option>
              <option value="price">Price</option>
              <option value="series">Project/Series</option>
              <option value="year">Year</option>
              <option value="notes">Notes</option>
            </select>
            <input id="bulkValue" type="text" placeholder="New value..." style="padding:6px; border:1px solid #ccc; border-radius:4px; flex:1; max-width:200px;">
            <button id="bulkApplyBtn" class="btn-small" type="button" style="background:#28a745; color:white; border:none; cursor:pointer;">Apply to Selected</button>
            <button id="bulkCancelBtn" class="btn-small" type="button" style="background:#6c757d; color:white; border:none; cursor:pointer;">Cancel</button>
          </div>
        </div>
      </div>

      {% if artworks and artworks|length > 0 %}
        <div class="items" id="items">
          {% for artwork in artworks %}
            <div class="row"
              data-artwork-id="{{ artwork.id }}"
              data-medium="{{ (artwork.medium or '')|lower|e }}"
              data-year="{{ (artwork.year or '')|lower|e }}"
              data-project="{{ (artwork.series or '')|lower|e }}"
              data-status="{{ (artwork.status or 'working')|lower|e }}"
              data-search="{{ (
                (artwork.title or '') ~ ' ' ~
                (artwork.medium or '') ~ ' ' ~
                (artwork.series or '') ~ ' ' ~
                (artwork.year or '') ~ ' ' ~
                (artwork.id|string)
              )|lower|e }}"
            >
              <div class="item" style="display:flex; align-items:center; gap:12px;">
                <input type="checkbox" class="artwork-checkbox" value="{{ artwork.id }}" style="width:18px; height:18px; cursor:pointer; flex-shrink:0;">

                <a class="rowlink"
                 href="{{ url_for('artworks.artwork_detail', artwork_id=artwork.id) }}"
                 style="text-decoration:none; color:inherit; flex:1; min-width:0; display:flex; align-items:center; gap:12px;"
              >
                  <div class="thumb">
                    {% if artwork.image_filename %}
                      <img src="{{ url_for('artworks.uploaded_file', filename=artwork.image_filename) }}" alt="">
                    {% endif %}
                  </div>

                  <div class="textlist">
                    <div class="title">{{ artwork.title }}</div>
                    <div class="meta">
                      {{ artwork.year or "‚Äî" }} ¬∑ {{ artwork.medium or "‚Äî" }}
                      {% if artwork.series %} ¬∑ {{ artwork.series }}{% endif %}
                      ¬∑ ID {{ artwork.id }}
                    </div>
                  </div>
                </a>

                <div class="right">
                           <!-- actions (not inside the <a>, so it won‚Äôt break clicks) -->
              <div style="display:flex; align-items:center; gap:8px;">
                <form method="post"
                      action="{{ url_for('artworks.delete_artwork', artwork_id=artwork.id) }}"
                      onsubmit="return confirm('Delete this artwork? This cannot be undone.');"
                      style="margin:0;"
                >
                  <button type="submit" class="btn-delete" style="opacity:.85;">Delete</button>
                </form>
              </div>
                    {% if artwork.status == 'for_sale' %}
                      <span class="tag tag-for-sale">üü¢ For sale</span>
                    {% elif artwork.status == 'sold' %}
                      <span class="tag tag-sold">üî¥ Sold</span>
                    {% else %}
                      <span class="tag tag-working">üîµ Working on</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <p id="emptyState" class="muted" style="display:none; margin-top:14px;">
          No artworks match your filters.
        </p>
      {% else %}
        <p class="muted" style="margin-top:14px;">No artworks yet.</p>
      {% endif %}

      <a class="back" href="{{ url_for('main.home') }}">‚Üê Home</a>
    </div>
  </div>

  <script>
    (function(){
      const q = document.getElementById('q');
      const fMedium = document.getElementById('fMedium');
      const fYear = document.getElementById('fYear');
      const fProject = document.getElementById('fProject');

      const items = document.getElementById('items');
      const emptyState = document.getElementById('emptyState');

      const shown = document.getElementById('shown');
      const activeText = document.getElementById('activeText');
      const resetBtn = document.getElementById('resetBtn');
      const printBtn = document.getElementById('printBtn');

      // Bulk edit elements
      const bulkEditSection = document.getElementById('bulkEditSection');
      const bulkField = document.getElementById('bulkField');
      const bulkValue = document.getElementById('bulkValue');
      const bulkApplyBtn = document.getElementById('bulkApplyBtn');
      const bulkCancelBtn = document.getElementById('bulkCancelBtn');
      const selectedCount = document.getElementById('selectedCount');

      const norm = (v) => (v || '').toString().trim().toLowerCase();

      function getSelectedCheckboxes() {
        return Array.from(document.querySelectorAll('.artwork-checkbox:checked'));
      }

      function updateBulkUI() {
        const selected = getSelectedCheckboxes();
        const hasSelection = selected.length > 0;
        selectedCount.textContent = selected.length;
        bulkEditSection.style.display = hasSelection ? '' : 'none';
      }

      function apply(){
        if (!items) return;

        const qs = norm(q.value);
        const m = norm(fMedium.value);
        const y = norm(fYear.value);
        const p = norm(fProject.value);

        const active = [];
        if (qs) active.push(`Search: ‚Äú${q.value.trim()}‚Äù`);
        if (m) active.push(`Material: ${fMedium.value}`);
        if (y) active.push(`Date: ${fYear.value}`);
        if (p) active.push(`Project: ${fProject.value}`);
        activeText.textContent = active.length ? active.join(' ¬∑ ') : '';

        let count = 0;
        const rows = items.querySelectorAll('.row');

        rows.forEach(row => {
          const ds = row.dataset;
          const okSearch = !qs || (ds.search || '').includes(qs);
          const okM = !m || (ds.medium || '') === m;
          const okY = !y || (ds.year || '') === y;
          const okP = !p || (ds.project || '') === p;

          const ok = okSearch && okM && okY && okP;
          row.style.display = ok ? '' : 'none';
          if (ok) count += 1;
        });

        shown.textContent = String(count);
        if (emptyState) emptyState.style.display = count === 0 ? '' : 'none';
        
        updateBulkUI();
      }

      async function applyBulkUpdate() {
        const selected = getSelectedCheckboxes();
        const field = bulkField.value;
        const value = bulkValue.value;

        if (!field) {
          alert('Please select a field to update');
          return;
        }

        if (!value && field !== 'for_sale') {
          alert('Please enter a value');
          return;
        }

        const artworkIds = selected.map(cb => parseInt(cb.value));

        try {
          const response = await fetch('{{ url_for("artworks.bulk_update_artworks") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              artwork_ids: artworkIds,
              field: field,
              value: value
            })
          });

          const data = await response.json();

          if (!response.ok) {
            alert('Error: ' + (data.error || 'Unknown error'));
            return;
          }

          alert(data.message || 'Update successful!');
          
          // Reload the page to reflect changes
          location.reload();
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      // Event listeners for checkboxes
      document.addEventListener('change', (e) => {
        if (e.target.classList.contains('artwork-checkbox')) {
          updateBulkUI();
        }
      });

      // Bulk edit buttons
      if (bulkApplyBtn) bulkApplyBtn.addEventListener('click', applyBulkUpdate);
      if (bulkCancelBtn) bulkCancelBtn.addEventListener('click', () => {
        document.querySelectorAll('.artwork-checkbox').forEach(cb => cb.checked = false);
        bulkField.value = '';
        bulkValue.value = '';
        updateBulkUI();
      });

      function reset(){
        q.value = '';
        fMedium.value = '';
        fYear.value = '';
        fProject.value = '';
        apply();
      }

      [q, fMedium, fYear, fProject].forEach(el => {
        if (!el) return;
        el.addEventListener('input', apply);
        el.addEventListener('change', apply);
      });

      if (resetBtn) resetBtn.addEventListener('click', reset);
      if (printBtn) printBtn.addEventListener('click', function(){ window.print(); });

      apply();
    })();
  </script>
</body>
</html>
